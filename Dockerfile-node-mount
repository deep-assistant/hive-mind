FROM node:20

# Install jq and sudo for JSON processing and user permissions
RUN apt-get update && apt-get install -y jq sudo && rm -rf /var/lib/apt/lists/*

# Install claude globally with npm
RUN npm install -g @anthropic-ai/claude-code

# Create claude user with sudo privileges and no password
RUN useradd -m -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    chown -R claude:claude /usr/local/lib/node_modules && \
    chown -R claude:claude /usr/local/bin

USER claude
WORKDIR /home/claude

# Copy the wrapper script
COPY --chown=claude:claude do.mjs /home/claude/do.mjs
RUN chmod +x /home/claude/do.mjs

# Set environment variable to use global claude installation
ENV CLAUDE_PATH=claude

# Set the entrypoint to our wrapper script
# Note: .claude folder should be mounted at runtime: -v ~/.claude:/home/claude/.claude
# Note: ~/.claude.json should be mounted at runtime: -v ~/.claude.json:/home/claude/.claude.json
ENTRYPOINT ["/home/claude/do.mjs"]