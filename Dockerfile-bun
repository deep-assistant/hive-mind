FROM oven/bun:1

# Install jq and npm for JSON processing and dynamic imports
RUN apt-get update && apt-get install -y jq npm && rm -rf /var/lib/apt/lists/*

# Install claude globally with bun
RUN bun add -g @anthropic-ai/claude-code

# Create claude user
RUN useradd -m -s /bin/bash claude
USER claude
WORKDIR /home/claude

# Copy only the .claude config folder (excluding node_modules and binaries)
COPY --chown=claude:claude claude-config/settings.json /home/claude/.claude/settings.json
COPY --chown=claude:claude claude-config/statsig /home/claude/.claude/statsig
COPY --chown=claude:claude claude-config/projects /home/claude/.claude/projects
COPY --chown=claude:claude claude-config/shell-snapshots /home/claude/.claude/shell-snapshots
COPY --chown=claude:claude claude-config/todos /home/claude/.claude/todos
COPY --chown=claude:claude claude-config/ide /home/claude/.claude/ide

# Copy the wrapper script and update claude path to use global installation
COPY --chown=claude:claude do.mjs /home/claude/do.mjs
RUN chmod +x /home/claude/do.mjs

# Set environment variable to use global claude installation
ENV CLAUDE_PATH=claude

# Set the entrypoint to our wrapper script
ENTRYPOINT ["/home/claude/do.mjs"]