name: Cleanup Test Repositories

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode - shows what would be deleted without actually deleting'
        required: false
        type: boolean
        default: false

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Configure GitHub CLI authentication
      env:
        GITHUB_TOKEN: ${{ secrets.TEST_GITHUB_USER_REPO_DELETION_TOKEN }}
      run: |
        echo "$GITHUB_TOKEN" | gh auth login --with-token
        echo ""
        echo "Checking GitHub authentication status..."
        gh auth status
        echo ""
        echo "Refreshing GitHub token with delete_repo scope..."
        gh auth refresh -h github.com -s delete_repo

    - name: Run cleanup script
      run: |
        echo "Starting test repository cleanup..."
        echo ""

        if [ "${{ inputs.dry_run }}" = "true" ]; then
          echo "Running in DRY RUN mode..."
          ./cleanup-test-repos.mjs --skip-archived --dry-run
        else
          echo "Running in FORCE mode (will delete repositories)..."
          ./cleanup-test-repos.mjs --skip-archived --force
        fi

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "Cleanup workflow completed!"
        if [ "${{ inputs.dry_run }}" = "true" ]; then
          echo "Mode: DRY RUN (no repositories were deleted)"
        else
          echo "Mode: FORCE (repositories were deleted)"
        fi
