FROM node:20

# Install jq and sudo for JSON processing and user permissions
RUN apt-get update && apt-get install -y jq sudo && rm -rf /var/lib/apt/lists/*

# Install claude globally with npm
RUN npm install -g @anthropic-ai/claude-code

# Create claude user with sudo privileges and no password
RUN useradd -m -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    chown -R claude:claude /usr/local/lib/node_modules && \
    chown -R claude:claude /usr/local/bin

USER claude
WORKDIR /home/claude

# Copy only the .claude config folder (excluding node_modules and binaries)
COPY --chown=claude:claude claude-config/settings.json /home/claude/.claude/settings.json
COPY --chown=claude:claude claude-config/statsig /home/claude/.claude/statsig
COPY --chown=claude:claude claude-config/projects /home/claude/.claude/projects
COPY --chown=claude:claude claude-config/shell-snapshots /home/claude/.claude/shell-snapshots
COPY --chown=claude:claude claude-config/todos /home/claude/.claude/todos
COPY --chown=claude:claude claude-config/ide /home/claude/.claude/ide

# Copy the wrapper script
COPY --chown=claude:claude do.mjs /home/claude/do.mjs
RUN chmod +x /home/claude/do.mjs

# Set environment variable to use global claude installation
ENV CLAUDE_PATH=claude

# Set the entrypoint to our wrapper script
ENTRYPOINT ["/home/claude/do.mjs"]